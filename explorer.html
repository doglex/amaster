<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="lib/vue.js"></script>
    <script>
        const infiniteScroll = require ('vue-infinite-scroll').infiniteScroll;
        Vue.use(infiniteScroll)
    </script>
    <style>
        body {
            background: #333;
            color: white;
        }
    </style>
</head>
<body >


<script>
    const thisDevice = localStorage.getItem("lastDevice-explorer")
    // document.write("设备管理器：", thisDevice)
    const fs = require("fs")
    const path = require('path');
    const cacheFolder = `tmp/${thisDevice}-explorer`
    fs.mkdirSync(cacheFolder, {recursive: true})
</script>



<div id="vFileTree" >
    <div style="font-size:20px">
    <span style="color:green;background:palegreen;width:500px"> {{device.substring(0,14)}} </span>
    <input placeholder="/" type="text" @keyup.enter="changePath"
           v-model="searchPath" style="width:calc(100% - 200px);
           height:20px;font-size:19px;vertical-align:top">
    </div>
    <div v-infinite-scroll="loadMore" infinite-scroll-disabled="busy" infinite-scroll-distance="20">
        <div v-for="(file, i) in showFiles">
            {{(file.type==="d" || file.type==="l") ?file.name + "/" :file.name}}
        </div>
    </div>
</div>

<script>
    const vFileTree = new Vue({
        el: '#vFileTree',
        data: {
            files: [],
            showFiles: [],
            searchPath: "/",
            currentPath: "/",
            device: thisDevice,
            useInfinite: false,
        },
        methods: {
            changePath: function() {
                refreshFileList(this.searchPath)
                this.currentPath = this.searchPath
            },
            loadMore: function() {
                if (!this.useInfinite || this.files.length === this.showFiles.length) return;
                this.busy = true
                setTimeout(() => {
                    for (var i = 0, j = 50; i < j && this.showFiles.length < this.files.length; i++) {
                        this.showFiles.push(this.files[this.showFiles.length])
                    }
                    console.log(this.data)
                    this.busy = false
                }, 30)
            }
        }
    })
</script>

<script>
    const {exec} = require('child_process');
    function refreshFileList(thisPath) {
        cmd = `adb -s ${thisDevice} shell ls -l ${thisPath} `
        exec(cmd, (err, stdout, stderr) => {
            if (err) {
                console.log(`[ERROR]: ${stderr}`);
                new Notification('Error', {
                    body: '无效路径. Invalid Path.'
                })
                return;
            }
            let tmp_files = []
            stdout.split("\n").forEach(
                line => {
                    line = line.trim()
                    line = line.replaceAll(" ", ",")
                    console.log(line)
                    lineParts = line.split(/,+/)
                    console.log(lineParts.length)
                    if (lineParts.length < 7) return;
                    let one = {
                        type: lineParts[0].substring(0, 1),
                        writeable: lineParts[0].substring(2, 3),
                        alterTime: `${lineParts[5]} ${lineParts[6]}`,
                        name: lineParts[7],
                        link: lineParts[9] || null
                    }
                    tmp_files.push(one)
                }
            )
            // console.log(JSON.stringify(tmp_files))
            vFileTree.files = tmp_files
            if (vFileTree.files.length < 100) {
                vFileTree.useInfinite = false;
                vFileTree.showFiles = vFileTree.files;
            } else {
              vFileTree.useInfinite = true;
              vFileTree.showFiles = vFileTree.files.slice(0,100);
            }

        })
    }
    refreshFileList("/")
</script>

</body>
</html>